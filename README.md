# 🌊 鳴潮 音骸スコア計算機 - 3エリア認識版 (開発中)

## 📋 概要
<<<<<<< HEAD
=======
画像をペーストするだけで、ゲームアイテムのスコアを自動計算するツールです 
**OpenCV.js + Tesseract.js** のハイブリッド方式で高精度なOCR認識を実現し、  
**3エリア認識システム**により、計算に含めるステータスと除外するステータスを自動で判別します。
>>>>>>> dd74f022eeb089f46525d233bca22f64d679097c

鳴潮の**音骸**（装備品）のスクリーンショットから、自動でステータスを認識してスコアを計算するツールです。

**現状**: OpenCV.js + Tesseract.js による3エリア認識システムを実装中です。  
**枠表示**は正確に動作していますが、**文字認識（OCR）の精度が不十分**のため、完全自動計算はまだできません。

## ⚠️ 認識がうまくいかない理由

| 問題 | 説明 |
|------|------|
| **Tesseract.js 日本語精度** | 50% 程度。ゲーム特有フォントに未対応 |
| **背景グラデーション** | ノイズとして誤認識される |
| **色付き文字** | 金色などの色付きテキストが認識されにくい |
| **数値と記号** | 「%」「+」と数字の組み合わせで誤認識 |

### 現実的な精度

- ✅ **エリア枠の表示**: 正確
- ⚠️ **ステータス名**: 30-60% の精度
- ⚠️ **数値**: 40-70% の精度  
- ❌ **完全自動計算**: 不安定

## 🎯 想定される使い方

このツールは以下のワークフローで使用することを想定しています:

```
1. スクショをペースト (Ctrl+V)
   ↓
2. 赤/橙/緑の枠が音骸画面に重なっているか確認
   ↓
3. デバッグ情報で OCR 結果を確認
   ↓
4. 認識されない場合は座標を手動調整
   ↓
5. スコア計算は参考値として利用
```

## 🔍 デバッグ情報の見方

### ステップ1: デバッグ表示をON

`信頼度を表示` チェックボックスをONにすると、結果欄下部に詳細情報が表示されます。

### ステップ2: 行検出数を確認

```
行検出: 除外 0 行 / 計算 0 行   ← ❌ ゼロならエリア座標がずれている
行検出: 除外 2 行 / 計算 5 行   ← ✅ ゼロでなければOK
```

**ゼロの場合**:
- エリア座標が画面内容にずれている
- 画像のコントラストが低い（グレーアウト状態など）
- 上部の座標入力で調整して「適用」を押す

### ステップ3: OCR 結果を確認

除外エリア OCR、計算エリア OCR に認識結果が表示されます:

```
除外[0]  凝縮ダメージアップ = 100%  75% ← 信頼度75%なら信用できる
除外[1]  xxxxx = xxxx  20%           ← 信頼度20%は信用できない
```

**信頼度 30% 未満は参考値程度**に考えてください。

### ステップ4: 処理後画像を確認

`処理後画像を表示` をONにすると、OpenCV による前処理後の画像が表示されます:

```
白い文字 + 黒い背景  → ✅ 理想的
グレーの文字  → ⚠️ 認識率が低い
ノイズが多い  → ❌ 座標を調整する
```

## 🛠️ 座標調整方法

スクショの解像度により、デフォルト座標がずれることがあります。

### 1. スクショをペースト

### 2. キャンバス上の枠を確認

- **赤枠**: 音骸名前が含まれているか
- **オレンジ枠**: メイン効果が含まれているか
- **緑枠**: サブステータスが含まれているか

### 3. ずれていれば上部の入力欄で調整

```
エリア座標
名X[ 720] Y[ 70] W[190] H[ 20]
メX[ 720] Y[140] W[205] H[ 20]
サX[ 720] Y[120] W[205] H[123]

[適用] [初期化]
```

- **X, Y**: エリアの左上座標
- **W, H**: エリアの幅と高さ
- **適用**: 変更を反映
- **初期化**: デフォルト値に戻す

### 4. デバッグ情報で確認

行検出数が 0 でなくなれば成功。

## 📐 座標計算例

デフォルト座標は **1366×768** のスクショ用です。

他の解像度の場合、以下のように計算してください:

```
基準: 1366×768
あなたのスクショ: 1920×1080

スケール = 1920 / 1366 ≈ 1.40

デフォルト座標: [720, 70, 190, 20]
↓
計算: [720×1.40, 70×1.40, 190×1.40, 20×1.40]
     = [1008, 98, 266, 28]
```

## 📁 ファイル構成

```
Wuthering-Waves-score/
├── index.html          # UI (座標入力欄付き)
├── app.js             # メイン制御
├── hybrid-ocr.js      # OpenCV + Tesseract
├── config.js          # 設定（座標・ビルド）
├── style.css          # スタイル
└── README.md          # このファイル
```

## 🔧 実装状況

### ✅ 実装済み

- グレースケール変換
- CLAHE (コントラスト調整)
- 適応的2値化
- モルフォロジー処理（ノイズ除去）
- ROI 抽出
- 水平投影による行検出
- Tesseract.js OCR 統合
- デバッグ情報表示

### ❌ 効果不十分

- **Tesseract.js**: 日本語精度が低い
- **HSV フィルタリング**: 色付きテキスト認識が弱い
- **輪郭検出**: テキスト領域特定がうまくいかない

### ❌ 未実装

- テンプレートマッチング
- 機械学習
- 動的座標自動調整

## 🎮 対応状況

| ゲーム | 対応 | 状況 |
|--------|------|------|
| 鳴潮 | ✅ | 3エリア認識実装（精度改善中） |
| 原神 | ❌ | 未対応 |
| スターレイル | ❌ | 未対応 |

## 🐛 トラブルシューティング

### 行検出数が 0 の場合

**原因**: エリア座標がずれている、またはコントラストが低い

**対応**:
1. デバッグ情報で実際の座標を確認
2. 上部の入力欄で調整
3. 「適用」を押す
4. デバッグ情報で再確認

### 信頼度が 30% 未満の場合

**原因**: テキストが不明確 / OCRエンジンが誤認識

**対応**:
1. 処理後画像を確認
2. グレー色ならコントラストを改善
3. スクショの解像度を上げる
4. 異なるビルドで試す

### OpenCV が読み込まれない

**原因**: CDN 接続エラーまたはブラウザキャッシュ

**対応**:
1. ネット接続を確認
2. ブラウザキャッシュをクリア
3. 別のブラウザで試す

## 📚 技術リファレンス

- [OpenCV.js](https://docs.opencv.org/4.5.0/index.html)
- [Tesseract.js](https://github.com/naptha/tesseract.js)
- [CLAHE](https://en.wikipedia.org/wiki/Adaptive_histogram_equalization)

## 📞 フィードバック

バグ報告や機能要望はお気軽に。

---

**最終更新**: 2025年12月20日  
**バージョン**: 開発版 v1.0  
**ブラウザ**: Chrome/Edge 90+, Firefox 88+, Safari 15+
