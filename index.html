<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web版 装備スコア計算機</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 基本的なスタイルと背景設定 */
        body {
            font-family: 'BIZ UDGothic', 'BIZ UDPGothic', serif; /* 明朝体フォント */
            /* ↓ここに高貴なダークゴールド系の背景画像URLを貼り付け。指定しない場合は下の黒背景になります */
            /* background-image: url('https://i.imgur.com/your-image.jpg'); */
            background-color: #121212;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* ローディングアニメーション */
        .loader {
            border: 5px solid #333;
            border-top: 5px solid #FFD700; /* Gold */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* フォーム要素のスタイル調整 */
        select, input[type="text"] {
            background-color: #1f1f1f;
            border: 1px solid #444;
            color: #f0f0f0;
            padding: 8px 12px;
            border-radius: 0; /* 角を立たせる */
            appearance: none;
        }
        select:focus, input[type="text"]:focus {
            border-color: #FFD700; /* Gold on focus */
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.4); /* Gold glow */
        }
        input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 1px solid #666;
            background-color: #1f1f1f;
            position: relative;
            vertical-align: middle;
            cursor: pointer;
            border-radius: 0; /* 角を立たせる */
        }
        input[type="checkbox"]:checked {
            background-color: #FFD700;
            border-color: #FFD700;
        }
        input[type="checkbox"]:checked::before {
            content: '✔';
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #121212;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-[#121212] text-[#e0e0e0]">

    <div class="container mx-auto p-4 max-w-3xl min-h-screen flex items-center justify-center">
        <div class="w-full bg-black/60 backdrop-blur-sm shadow-2xl border border-[#444]/50 p-6">
            
            <div class="flex flex-wrap items-start gap-4 mb-4">
                <div class="flex items-center">
                    <label for="game-select" class="font-bold mr-2 text-[#DAA520]">★ ゲーム:</label>
                    <select id="game-select" class="p-2 shadow-sm"></select>
                </div>
                <div class="flex items-center">
                    <label id="character-label" for="character-select" class="font-bold mr-2 text-[#DAA520]">① キャラクター:</label>
                    <select id="character-select" class="p-2 shadow-sm"></select>
                </div>
            </div>

            <div id="canvas-container" class="relative w-full h-80 bg-black/50 border-2 border-dashed border-[#555] flex justify-center items-center mb-4 overflow-hidden transition-all duration-300">
                <canvas id="image-canvas" class="hidden"></canvas>
                <div id="info-overlay" class="text-center text-gray-400">
                    <p id="paste-label" class="text-lg font-bold">ここにスクリーンショットを Ctrl+V</p>
                    <p class="text-sm">(または画像をドラッグ＆ドロップ)</p>
                </div>
                <div id="loader-overlay" class="absolute inset-0 bg-black/80 flex-col justify-center items-center hidden">
                    <div class="loader mb-2"></div>
                    <p id="loader-text" class="text-[#FFD700] font-semibold">OCRでステータスを認識中...</p>
                </div>
            </div>

            <div class="flex items-center mb-4">
                <input type="checkbox" id="show-processed-check">
                <label for="show-processed-check" class="ml-2 block text-sm text-gray-400">処理後画像を表示 (デバッグ用)</label>
            </div>

            <div class="bg-black/40 p-4 border border-[#333]">
                <h3 id="item-name-title-label" class="text-center font-bold text-lg mb-1 text-gray-400 tracking-widest">--- 認識された装備 ---</h3>
                <p id="item-name-label" class="text-center text-xl font-semibold text-[#FFD700] mb-4">...</p>
                
                <div id="result-table" class="space-y-1 text-sm">
                    </div>
                
                <div class="mt-4">
                    <p id="formula-label" class="text-xs text-gray-500 text-center">計算式:</p>
                    <div id="score-label" class="text-center text-5xl font-bold bg-gradient-to-br from-[#444] to-[#222] border border-[#555] text-white p-3 mt-1 shadow-lg">0</div>
                </div>
            </div>
        </div>
        <footer class="fixed bottom-2 right-4 text-xs text-white/30">
            <p>Web版 装備スコア計算機</p>
        </footer>
    </div>

<script>
// ===================================================================
// ゲーム設定
// ===================================================================
const GAME_CONFIGS = {
    "鳴潮": {
        "title": "鳴潮 音骸スコア計算機",
        "item_name_crop_area": [1380, 135, 1800 - 1380, 185 - 135],
        "stats_crop_area": [1400, 230, 1880 - 1400, 530 - 230],
        "character_label": "① キャラクター:",
        "paste_label": "② ここに音骸のスクショをCtrl+V",
        "recognized_item_label": "--- 認識された音骸 ---",
        "ocr_settings": {
            "threshold": 128,
            "tesseract_config": {
                "psm": 4,
                "tessedit_char_whitelist": "0123456789%+.攻撃力防御HPクリティカルダメージ効率アップ重撃通常スキル解放共鳴治癒効果消滅伝導回折凝縮熱熔気動"
            }
        },
        "stat_map": { 'クリティカル': 'クリティカル','クリティカルダメージ': 'クリティカルダメージ','HP': 'HP','攻撃力': '攻撃力','防御力': '防御力','共鳴効率': '共鳴効率','共鳴解放ダメージアップ': '共鳴解放ダメージアップ','共鳴スキルダメージアップ': '共鳴スキルダメージアップ','重撃ダメージアップ': '重撃ダメージアップ','通常攻撃ダメージアップ': '通常攻撃ダメージアップ','治癒効果': '治癒効果','消滅ダメージアップ': '消滅ダメージアップ','伝導ダメージアップ': '伝導ダメージアップ','回折ダメージアップ': '回折ダメージアップ','凝縮ダメージアップ': '凝縮ダメージアップ','熱熔ダメージアップ': '熱熔ダメージアップ','気動ダメージアップ': '気動ダメージアップ', '攻撃カ': '攻撃力', 'クリティ力ル': 'クリティカル', '共鳴効串': '共鳴効率' },
        "parsing_rules": { "regex": /(.+?)\s+([\d.,]+%?)$/, "stat_types": ['攻撃力', 'HP', '防御力']},
        "character_builds": { "丹瑾": { "main": { '消滅ダメージアップ': 1,'クリティカル': 1, 'クリティカルダメージ': 1,'攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '重撃ダメージアップ': 1.0, '共鳴スキルダメージアップ': 0.75, '攻撃力(実数値)': 0.05, '共鳴解放ダメージアップ': 0.25 } }, "オーガスタ": { "main": { '電導ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '重撃ダメージアップ': 1.0, '攻撃力(%)': 1.0, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '通常攻撃ダメージアップ': 0.25, '共鳴スキルダメージアップ': 0.25 } }, "折枝": { "main": { '凝縮ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '通常攻撃ダメージアップ': 1.0, '共鳴スキルダメージアップ': 0.75, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05 } }, "長離": { "main": { '熱熔ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '共鳴スキルダメージアップ': 1.0, '共鳴効率': 0.8, '共鳴解放ダメージアップ': 0.25, '攻撃力(実数値)': 0.05 } }, "今汐": { "main": { '回折ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '共鳴スキルダメージアップ': 1.0, '共鳴効率': 0.8, '通常攻撃ダメージアップ': 0.75, '共鳴解放ダメージアップ': 0.25, '攻撃力(実数値)': 0.05 } }, "カルロッタ": { "main": { '凝縮ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '共鳴スキルダメージアップ': 1.0, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '通常攻撃ダメージアップ': 0.25 } }, "ツバキ": { "main": { '攻撃力(%)': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '消滅ダメージアップ': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '通常攻撃ダメージアップ': 1.0, '攻撃力(実数値)': 0.05, '共鳴効率': 0.8, '共鳴解放ダメージアップ': 0.25 } }, "ショアキーパー": { "main": { 'HP(%)': 1, '共鳴効率': 1, 'クリティカルダメージ': 1, 'HP回復効果アップ': 1 }, "sub": { '共鳴効率': 1.0, 'クリティカルダメージ': 1.0, 'HP(%)': 1.0, '共鳴解放ダメージアップ': 1.0, '共鳴スキルダメージアップ': 0.75, 'HP(実数値)': 0.05, 'クリティカル': 0.25 } }, "フローヴァ": { "main": { '消滅ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '共鳴スキルダメージアップ': 1.0, '攻撃力(%)': 1.0, '攻撃力(実数値)': 0.05, '通常攻撃ダメージアップ': 0.25, '重撃ダメージアップ': 0.25 } }, "ルバ": { "main": { '熱熔ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '共鳴解放ダメージアップ': 1.0, '共鳴効率': 0.8, '共鳴スキルダメージアップ': 0.75, '攻撃力(実数値)': 0.05, '通常攻撃ダメージアップ': 0.25, '重撃ダメージアップ': 0.25 } }, "カルデシア": { "main": { 'HP(%)': 1, '気動ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, 'HP(%)': 1.0, '通常攻撃ダメージアップ': 1.0, '共鳴解放ダメージアップ': 1.0, '共鳴効率': 0.8, 'HP(実数値)': 0.05, '重撃ダメージアップ': 0.25, '共鳴スキルダメージアップ': 0.25 } }, "プラント": { "main": { 'クリティカル': 1, 'クリティカルダメージ': 1, '共鳴効率': 1, '攻撃力(%)': 1, '熱熔ダメージアップ': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '共鳴効率': 1.0, '攻撃力(%)': 1.0, '通常攻撃ダメージアップ': 1.0, '攻撃力(実数値)': 0.05, '共鳴解放ダメージアップ': 0.25 } }, "フィービー": { "main": { '回折ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '重撃ダメージアップ': 1.0, '共鳴解放ダメージアップ': 0.75, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '通常攻撃ダメージアップ': 0.25, '共鳴スキルダメージアップ': 0.25 } }, "ロココ": { "main": { '消滅ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '重撃ダメージアップ': 1.0, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '共鳴スキルダメージアップ': 0.25 } }, "ザンニー": { "main": { '回折ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '重撃ダメージアップ': 1.0, '共鳴解放ダメージアップ': 0.75, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '通常攻撃ダメージアップ': 0.25, '共鳴スキルダメージアップ': 0.25 } }, "カンタレラ": { "main": { 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1, '消滅ダメージアップ': 1, '共鳴効率': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '通常攻撃ダメージアップ': 1.0, '攻撃力(%)': 1.0, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '共鳴解放ダメージアップ': 0.25, '共鳴スキルダメージアップ': 0.25 } }, "カカロ": { "main": { '電導ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '共鳴効率': 0.8, '通常攻撃ダメージアップ': 0.75, '共鳴解放ダメージアップ': 0.75, '共鳴スキルダメージアップ': 0.75 } }, "ヴェリーナ": { "main": { '共鳴効率': 1, 'HP回復効果アップ': 1, '攻撃力(%)': 1 }, "sub": { '共鳴効率': 1.0, '攻撃力(%)': 1.0, '攻撃力(実数値)': 0.05, 'クリティカルダメージ': 0, 'クリティカル': 0 } }, "アンコ": { "main": { '熱熔ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '通常攻撃ダメージアップ': 1.0, '攻撃力(%)': 1.0, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '共鳴スキルダメージアップ': 0.75 } }, "忌炎": { "main": { '気動ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '重撃ダメージアップ': 1.0, '攻撃力(%)': 1.0, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '共鳴スキルダメージアップ': 0.25 } }, "吟霖": { "main": { '電導ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '共鳴スキルダメージアップ': 1.0, '共鳴解放ダメージアップ': 1.0, '攻撃力(実数値)': 0.05, '共鳴効率': 0.8 } }, "鑑心": { "main": { '気動ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '重撃ダメージアップ': 1.0, '共鳴解放ダメージアップ': 0.8, '攻撃力(実数値)': 0.05, '共鳴効率': 0.75 } }, "凌陽": { "main": { '凝縮ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '通常攻撃ダメージアップ': 1.0, '攻撃力(%)': 1.0, '攻撃力(実数値)': 0.05, '共鳴スキルダメージアップ': 0.75, '共鳴効率': 0.75 } }, "相里要": { "main": { '電導ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '共鳴解放ダメージアップ': 1.0, '攻撃力(実数値)': 0.05, '共鳴効率': 0.8, '通常攻撃ダメージアップ': 0.25 } }, "シャコンヌ": { "main": { '気動ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '重撃ダメージアップ': 1.0, '共鳴効率': 0.8, '共鳴解放ダメージアップ': 0.75, '攻撃力(実数値)': 0.05, '通常攻撃ダメージアップ': 0.25, '共鳴スキルダメージアップ': 0.25 } }, "漂泊者(消滅)": { "main": { '消滅ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '攻撃力(%)': 1.0, '攻撃力(実数値)': 0.05, '共鳴解放ダメージアップ': 0.75, '共鳴スキルダメージアップ': 0.75, '通常攻撃ダメージアップ': 0.25 } }, "漂泊者(回折)": { "main": { '回折ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '共鳴スキルダメージアップ': 1.0, '攻撃力(%)': 1.0, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '共鳴解放ダメージアップ': 0.75 } }, "漂泊者(気動)": { "main": { '気動ダメージアップ': 1, 'クリティカル': 1, 'クリティカルダメージ': 1, '攻撃力(%)': 1 }, "sub": { 'クリティカル': 1.0, 'クリティカルダメージ': 1.0, '共鳴スキルダメージアップ': 1.0, '攻撃力(%)': 1.0, '共鳴効率': 0.8, '攻撃力(実数値)': 0.05, '通常攻撃ダメージアップ': 0.25, '共鳴解放ダメージアップ': 0.25 } } }
    },
    "原神": {
        "title": "原神 聖遺物スコア計算機",
        "item_name_crop_area": [1450, 160, 1750 - 1450, 210 - 160],
        "stats_crop_area": [1450, 205, 1900 - 1450, 490 - 205],
        "character_label": "① ビルドタイプ:",
        "paste_label": "② 聖遺物画面のスクリーンショットをCtrl+V",
        "recognized_item_label": "--- 認識した聖遺物 ---",
        "ocr_settings": {
            "threshold": 200,
            "tesseract_config": {
                "psm": 6,
                "tessedit_char_whitelist": "0123456789%+.攻撃力防御HP会心率ダメージ元素チャージ効率熟知物理炎水雷氷風岩草与える治療効果バフ"
            }
        },
        "stat_map": { '会心率': '会心率', '会心ダメージ': '会心ダメージ', '攻撃力': '攻撃力', 'HP': 'HP', '防御力': '防御力', '元素チャージ効率': '元素チャージ効率', '元素熟知': '元素熟知', '物理ダメージバフ': '物理ダメージバフ', '炎元素ダメージ': '炎元素ダメージ', '水元素ダメージ': '水元素ダメージ', '雷元素ダメージ': '雷元素ダメージ', '氷元素ダメージ': '氷元素ダメージ', '風元素ダメージ': '風元素ダメージ', '岩元素ダメージ': '岩元素ダメージ', '草元素ダメージ': '草元素ダメージ', '与える治療効果': '与える治療効果', '攻撃カ': '攻撃力', '会心卒': '会心率' },
        "parsing_rules": {"regex": /(.+?)\s*\+?\s*([\d.,]+%?)/, "stat_types": ['攻撃力', 'HP', '防御力']},
        "character_builds": { "攻撃": { "sub": {'攻撃力(%)': 1, '会心率': 2, '会心ダメージ': 1} }, "HP": { "sub": {'HP(%)': 1, '会心率': 2, '会心ダメージ': 1} }, "防御": { "sub": {'防御力(%)': 1, '会心率': 2, '会心ダメージ': 1} }, "元素熟知": { "sub": {'元素熟知': 0.25, '会心率': 2, '会心ダメージ': 1} }, "チャージ": { "sub": {'元素チャージ効率': 1, '会心率': 2, '会心ダメージ': 1, '攻撃力(%)': 0.75} } }
    },
    "崩壊：スターレイル": {
        "title": "崩壊：スターレイル 遺物スコア計算機",
        "item_name_crop_area": [1480, 150, 1880-1480, 220-150],
        "relic_piece_crop_area": [90, 100, 500-90, 180-100],
        "stats_crop_area": [1480, 270, 1980-1480, 500-270],
        "character_label": "① ビルドタイプ:",
        "paste_label": "② 遺物画面のスクリーンショットをCtrl+V",
        "recognized_item_label": "--- 認識した遺物 ---",
        "ocr_settings": {
            "threshold": 190,
            "tesseract_config": {
                "psm": 6,
                "tessedit_char_whitelist": "0123456789%+.HP攻撃力防御力速度会心率ダメージ撃破特効治癒量効果命中抵抗物理炎氷雷風量子虚数属性EP回復効率"
            }
        },
        "stat_map": { 'HP': 'HP', '攻撃力': '攻撃力', '防御力': '防御力', '速度': '速度', '会心率': '会心率', '会心ダメージ': '会心ダメージ', '撃破特効': '撃破特効', '治癒量': '治癒量', '効果命中': '効果命中', '効果抵抗': '効果抵抗', '物理属性ダメージ': '物理属性ダメージ', '炎元素ダメージ': '炎元素ダメージ', '氷元素ダメージ': '氷元素ダメージ', '雷元素ダメージ': '雷元素ダメージ', '風元素ダメージ': '風元素ダメージ', '量子属性ダメージ': '量子属性ダメージ', '虚数属性ダメージ': '虚数属性ダメージ', 'EP回復効率': 'EP回復効率', '攻撃カ': '攻撃力', '会心卒': '会心率' },
        "parsing_rules": {"regex": /(.+?)\s*\+?\s*([\d.,]+%?)/, "stat_types": ['攻撃力', 'HP', '防御力']},
        "character_builds": { "汎用アタッカー": { "main": { '攻撃力(%)': 1, '会心率': 1, '会心ダメージ': 1, '速度': 1, '物理属性ダメージ': 1, '炎属性ダメージ': 1, '氷属性ダメージ': 1, '雷属性ダメージ': 1, '風属性ダメージ': 1, '量子属性ダメージ': 1, '虚数属性ダメージ': 1, }, "sub": { '攻撃力(%)': 1, '会心率': 1, '会心ダメージ': 1, '速度': 1, '撃破特効': 0.5 } }, "ホタル": { "main": { '攻撃力(%)': 1, '速度': 1, '撃破特効': 1, '炎属性ダメージ': 1, }, "sub": { '攻撃力(%)': 0.5, '攻撃力(実数値)': 0.2, '速度': 1, '撃破特効': 1 } } },
        "theoretical_sub_values": { 'HP(実数値)': 42.336, '攻撃力(実数値)': 21.168, '防御力(実数値)': 21.168, 'HP(%)': 4.32, '攻撃力(%)': 4.32, '防御力(%)': 5.4, '会心率': 3.24, '会心ダメージ': 6.48, '効果命中': 4.32, '効果抵抗': 4.32, '撃破特効': 6.48, '速度': 2.6 }
    }
};


// ===================================================================
// アプリケーション本体 (ロジックは変更なし)
// ===================================================================
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM要素の取得 ---
    const gameSelect = document.getElementById('game-select');
    const characterSelect = document.getElementById('character-select');
    const charLabel = document.getElementById('character-label');
    const canvasContainer = document.getElementById('canvas-container');
    const imageCanvas = document.getElementById('image-canvas');
    const ctx = imageCanvas.getContext('2d', { willReadFrequently: true });
    const infoOverlay = document.getElementById('info-overlay');
    const pasteLabel = document.getElementById('paste-label');
    const loaderOverlay = document.getElementById('loader-overlay');
    const loaderText = document.getElementById('loader-text');
    const showProcessedCheck = document.getElementById('show-processed-check');
    const itemNameTitleLabel = document.getElementById('item-name-title-label');
    const itemNameLabel = document.getElementById('item-name-label');
    const resultTable = document.getElementById('result-table');
    const formulaLabel = document.getElementById('formula-label');
    const scoreLabel = document.getElementById('score-label');

    // --- アプリケーションの状態管理 ---
    let originalImage = null;
    let currentConfig = null;
    let fuse = null;

    // --- OCRワーカーの初期化 ---
    let ocrWorker = null;
    async function initializeOcrWorker() {
        loaderText.textContent = 'OCRエンジンを準備中...';
        loaderOverlay.style.display = 'flex';
        ocrWorker = await Tesseract.createWorker('jpn', 1, {
            logger: m => console.log(m)
        });
        loaderOverlay.style.display = 'none';
        console.log('Tesseract Worker Initialized');
    }
    initializeOcrWorker();

    // --- 初期化処理 ---
    function initialize() {
        Object.keys(GAME_CONFIGS).forEach(gameName => {
            const option = document.createElement('option');
            option.value = gameName;
            option.textContent = gameName;
            gameSelect.appendChild(option);
        });
        gameSelect.value = Object.keys(GAME_CONFIGS)[0];
        onGameChange();
        setupDragAndDrop();
    }

    // --- イベントリスナー ---
    gameSelect.addEventListener('change', onGameChange);
    characterSelect.addEventListener('change', processAndDisplay);
    showProcessedCheck.addEventListener('change', displayImage);
    window.addEventListener('paste', handlePaste);

    // --- ゲーム変更時の処理 ---
    function onGameChange() {
        const gameName = gameSelect.value;
        currentConfig = GAME_CONFIGS[gameName];
        
        document.title = currentConfig.title;
        charLabel.textContent = currentConfig.character_label;
        pasteLabel.textContent = currentConfig.paste_label;
        itemNameTitleLabel.textContent = currentConfig.recognized_item_label;

        characterSelect.innerHTML = '';
        const charBuilds = currentConfig.character_builds;
        Object.keys(charBuilds).forEach(charName => {
            const option = document.createElement('option');
            option.value = charName;
            option.textContent = charName;
            characterSelect.appendChild(option);
        });
        
        const statKeys = Object.keys(currentConfig.stat_map);
        fuse = new Fuse(statKeys, { includeScore: true, threshold: 0.5 });

        resetResults();
        displayImage();
    }

    // --- 画像処理 & 表示 ---
    function handleImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                originalImage = img;
                infoOverlay.style.display = 'none';
                imageCanvas.classList.remove('hidden');
                processAndDisplay();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function handlePaste(e) {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                handleImage(file);
                break;
            }
        }
    }

    function setupDragAndDrop() {
        canvasContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            canvasContainer.classList.add('border-[#FFD700]', 'bg-black/70');
        });
        canvasContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            canvasContainer.classList.remove('border-[#FFD700]', 'bg-black/70');
        });
        canvasContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            canvasContainer.classList.remove('border-[#FFD700]', 'bg-black/70');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImage(files[0]);
            }
        });
    }

    async function processAndDisplay() {
        if (!originalImage || !ocrWorker) return;
        resetResults();
        displayImage();

        loaderText.textContent = 'OCRでステータスを認識中...';
        loaderOverlay.style.display = 'flex';
        
        try {
            const statsCropArea = currentConfig.stats_crop_area;
            const processedCanvas = await preprocessForOcr(originalImage, statsCropArea, currentConfig.ocr_settings);
            
            const { data: { text } } = await ocrWorker.recognize(processedCanvas, {}, currentConfig.ocr_settings.tesseract_config);

            const statsForCalc = parseStats(text);
            if (statsForCalc.length === 0) {
                alert(`ステータスを読み取れませんでした。\n\n[認識した元テキスト]:\n${text}`);
                return;
            }
            
            const build = currentConfig.character_builds[characterSelect.value];
            const { total_score, scored_stats, formula } = calculateScore(statsForCalc, build);
            
            displayResults(scored_stats, formula, total_score);

        } catch (error) {
            console.error("処理エラー:", error);
            alert("画像の解析中に予期せぬエラーが発生しました。");
        } finally {
            loaderOverlay.style.display = 'none';
            if (showProcessedCheck.checked) {
                displayImage();
            }
        }
    }

    function displayImage() {
        if (!originalImage) {
            imageCanvas.classList.add('hidden');
            infoOverlay.style.display = 'flex';
            return;
        }

        imageCanvas.width = originalImage.width;
        imageCanvas.height = originalImage.height;
        ctx.drawImage(originalImage, 0, 0);

        if (showProcessedCheck.checked) {
            const statsCropArea = currentConfig.stats_crop_area;
            preprocessForOcr(originalImage, statsCropArea, currentConfig.ocr_settings)
                .then(processedCanvas => {
                    ctx.drawImage(processedCanvas, statsCropArea[0], statsCropArea[1]);
                    drawBoundingBoxes();
                    fitCanvasToContainer();
                });
        } else {
            drawBoundingBoxes();
            fitCanvasToContainer();
        }
    }
    
    function drawBoundingBoxes() {
        if(currentConfig.item_name_crop_area) {
            ctx.strokeStyle = "red";
            ctx.lineWidth = 3;
            ctx.strokeRect(...currentConfig.item_name_crop_area);
        }
        if(currentConfig.stats_crop_area) {
            ctx.strokeStyle = "#FFD700"; /* Gold */
            ctx.lineWidth = 3;
            ctx.strokeRect(...currentConfig.stats_crop_area);
        }
    }
    
    function fitCanvasToContainer() {
        const ratio = Math.min(canvasContainer.clientWidth / imageCanvas.width, canvasContainer.clientHeight / imageCanvas.height);
        imageCanvas.style.width = `${imageCanvas.width * ratio}px`;
        imageCanvas.style.height = `${imageCanvas.height * ratio}px`;
    }

    async function preprocessForOcr(img, crop, settings) {
        const [x, y, w, h] = crop;
        const scale = 3.0;

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w * scale;
        tempCanvas.height = h * scale;
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCtx.drawImage(img, x, y, w, h, 0, 0, w * scale, h * scale);
        
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i+1] + data[i+2]) / 3;
            const inverted = 255 - avg;
            data[i] = inverted;
            data[i+1] = inverted;
            data[i+2] = inverted;
        }
        tempCtx.putImageData(imageData, 0, 0);

        const contrastImageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const contrastData = contrastImageData.data;
        let min = 255, max = 0;
        for (let i = 0; i < contrastData.length; i += 4) {
            if (contrastData[i] < min) min = contrastData[i];
            if (contrastData[i] > max) max = contrastData[i];
        }
        const range = max - min;
        if (range > 0) {
            for (let i = 0; i < contrastData.length; i += 4) {
                const value = ((contrastData[i] - min) / range) * 255;
                const binary = value > settings.threshold ? 255 : 0;
                contrastData[i] = binary;
                contrastData[i+1] = binary;
                contrastData[i+2] = binary;
            }
        }
        tempCtx.putImageData(contrastImageData, 0, 0);

        return tempCanvas;
    }

    // --- パース & 計算 ---
    function findBestStatMatch(name) {
        const results = fuse.search(name.replace(/[+.\s]/g, ''));
        if (results.length > 0) {
            return results[0].item;
        }
        return null;
    }

    function parseStats(text) {
        let statsForCalc = [];
        const lines = text.split('\n').filter(line => line.trim() !== '');
        
        for (const line of lines) {
            const match = line.match(currentConfig.parsing_rules.regex);
            if (match) {
                const rawName = match[1].trim();
                const value = match[2].trim();
                
                const matchedName = findBestStatMatch(rawName);
                if(matchedName) {
                    const canonicalName = currentConfig.stat_map[matchedName];
                    let statKey = canonicalName;
                    if (currentConfig.parsing_rules.stat_types.includes(canonicalName)) {
                        statKey = value.includes('%') ? `${canonicalName}(%)` : `${canonicalName}(実数値)`;
                    }
                    statsForCalc.push([statKey, value]);
                }
            }
        }
        return statsForCalc;
    }

    function calculateScore(stats, build) {
        let total_score = 0;
        let scored_stats = [];
        let formula_parts = [];

        const mainMult = build.main || {};
        const subMult = build.sub || {};

        stats.forEach((stat, i) => {
            const [key, valueStr] = stat;
            let current_score = 0;
            let tag = 'sub';

            // 鳴潮のメインOP処理
            if (i === 0 && gameSelect.value === "鳴潮") { 
                tag = 'main';
                if (mainMult[key] > 0) {
                    current_score = 15.0; // 鳴潮のメインOPは固定スコア
                }
            } else { // サブOPの処理 (全ゲーム共通)
                const numericValue = parseFloat(valueStr.replace('%', '').replace(',', '')) || 0;
                const multiplier = subMult[key] || 0;
                current_score = numericValue * multiplier;
            }
            
            total_score += current_score;
            if (current_score > 0.001) {
                formula_parts.push(current_score.toFixed(2));
            }
            scored_stats.push({ name: key, value: valueStr, score: current_score, tag });
        });

        const formula = formula_parts.length > 0 ? formula_parts.join(" + ") + ` = ${total_score.toFixed(2)}` : '計算対象ステータスがありません';
        return { total_score, scored_stats, formula };
    }

    // --- 結果表示 ---
    function resetResults() {
        itemNameLabel.textContent = '...';
        resultTable.innerHTML = '';
        formulaLabel.textContent = '計算式:';
        scoreLabel.textContent = '0';
    }

    function displayResults(scored_stats, formula, total_score) {
        resultTable.innerHTML = '';
        scored_stats.forEach(stat => {
            const row = document.createElement('div');
            const scoreColorClass = stat.score > 10 ? 'text-[#FFD700]' : stat.score > 5 ? 'text-[#a0a0a0]' : 'text-[#666]';
            const tagClass = stat.tag === 'main' ? 'bg-black/50 font-bold border-l-4 border-[#DAA520]' : 'bg-[#1c1c1c]/50';
            
            row.className = `grid grid-cols-3 gap-2 p-2 ${tagClass}`;
            row.innerHTML = `
                <span class="col-span-1 truncate">${stat.name}</span>
                <span class="text-center font-mono">${stat.value}</span>
                <span class="text-right font-mono ${scoreColorClass}">${stat.score.toFixed(2)}</span>
            `;
            resultTable.appendChild(row);
        });
        formulaLabel.textContent = `計算式: ${formula}`;
        scoreLabel.textContent = Math.round(total_score);
    }
    
    // アプリケーション起動
    initialize();
});
</script>
</body>
</html>
