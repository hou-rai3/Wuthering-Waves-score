<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>鳴潮 音骸スコアチェッカー</title>
<link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="main">
  <div class="header">
    <div class="title">鳴潮 音骸スコアチェッカー</div>
    <div class="badge">ゼロ・ウェイティング</div>
  </div>
  <p class="lead">ステータス画面をコピーしてペーストしてください (Ctrl+V)。モデルは起動直後にウォームアップされます。</p>
  <div class="dropzone" id="dropzone">
    <div class="drop-icon">⭳</div>
    <div class="drop-text">ここにペースト / ドロップ</div>
    <div class="drop-sub">クリップボード画像やスクリーンショットをそのまま投入できます。フルHD推奨。</div>
  </div>
  <div class="status-row">
    <div class="status-text" id="status">モデル読み込み中...</div>
    <div class="badge" aria-live="polite">リアルタイム解析</div>
  </div>
  <div class="score-box">
    <span class="score-label">Score</span>
    <span class="score-value" id="score">--</span>
  </div>
  
  <!-- 認識結果表示 -->
  <div id="results-panel" style="display:none; margin-top: 20px; padding: 20px; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px;">
    <h3 style="color: #00ffff; margin-top: 0;">認識結果</h3>
    <div id="parsed-data" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
    
    <h3 style="color: #00ffff; margin-top: 20px;">統計情報</h3>
    <div id="stats-info" style="font-family: monospace; color: #fff; line-height: 1.8;"></div>
    
    <details style="margin-top: 20px;">
      <summary style="color: #00ffff; cursor: pointer; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 4px;">🔧 デバッグ情報（全93ボックス）</summary>
      <div id="debug-details" style="margin-top: 10px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #aaa;"></div>
    </details>
  </div>
  
  <div class="button-row">
    <button class="btn" id="reset-btn" type="button">リセット</button>
    <button class="btn" id="sample-btn" type="button">サンプル画像でテスト</button>
  </div>
  <div class="hint">ペーストを検知するとバックグラウンドで非同期推論を実行します。UIはブロックされません。</div>
</div>
<canvas id="hidden" width="1920" height="1080"></canvas>

<script>
const statusEl = document.getElementById("status");
const scoreEl = document.getElementById("score");
const hidden = document.getElementById("hidden");
const ctx = hidden.getContext("2d");
const resetBtn = document.getElementById("reset-btn");
const sampleBtn = document.getElementById("sample-btn");
const dropZone = document.getElementById("dropzone");

const API_URL = "http://localhost:5000/predict";
let warm = false;

async function init() {
  statusEl.textContent = "サーバー接続確認中...";
  try {
    const res = await fetch("http://localhost:5000/");
    if (res.ok) {
      warm = true;
      statusEl.textContent = "準備完了。画像をペーストしてください。";
    } else {
      statusEl.textContent = "サーバーが起動していません。python server.py を実行してください。";
    }
  } catch (e) {
    statusEl.textContent = "サーバーが起動していません。python server.py を実行してください。";
  }
}
init();

document.addEventListener("paste", async (e) => {
  if (!warm) return;
  const item = [...e.clipboardData.items].find(i => i.type.startsWith("image/"));
  if (!item) { statusEl.textContent = "画像が見つかりませんでした"; return; }
  const file = item.getAsFile();
  await handleFile(file);
});

function computeScore(preds){
  const weights = { "会心":2.0, "攻撃":1.0, "%":1.0 };
  let s = 0;
  for (const p of preds){
    if (weights[p]) s += weights[p];
    else if (!isNaN(Number(p))) s += Number(p);
  }
  return s;
}

function setStatus(message, busy=false) {
  statusEl.textContent = message;
  dropZone.dataset.state = busy ? "busy" : "idle";
}

async function handleFile(file) {
  if (!file) { setStatus("画像が見つかりませんでした", false); return; }
  setStatus("解析中...", true);
  
  const reader = new FileReader();
  reader.onload = async (ev) => {
    const imageData = ev.target.result;
    
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: imageData })
      });
      
      if (!response.ok) {
        throw new Error('サーバーエラー');
      }
      
      const result = await response.json();
      const score = computeScore(result.predictions);
      scoreEl.textContent = score.toFixed(2);
      
      // 認識結果の詳細表示
      displayResults(result);
      
      setStatus("完了 (" + result.stats.elapsed_ms + "ms)", false);
    } catch (err) {
      setStatus("エラー: " + err.message, false);
    }
  };
  reader.readAsDataURL(file);
}

function displayResults(result) {
  const resultsPanel = document.getElementById('results-panel');
  const parsedData = document.getElementById('parsed-data');
  const statsInfo = document.getElementById('stats-info');
  const debugDetails = document.getElementById('debug-details');
  
  resultsPanel.style.display = 'block';
  
  // 単語ベースの結果を表示
  const items = result.results.map((r, i) => {
    const isAccurate = r.confidence > 50;
    const color = isAccurate ? '#0f0' : '#f90';
    return `<div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px;">
      <div style="color: #00ffff; font-size: 12px; margin-bottom: 5px;">${r.label} (${r.type})</div>
      <div style="color: ${color}; font-size: 16px; font-weight: bold;">${r.predicted || '(未認識)'}</div>
      <div style="color: #999; font-size: 10px; margin-top: 4px;">信頼度: ${r.confidence}%</div>
    </div>`;
  }).join('');
  
  parsedData.innerHTML = items;
  
  // 統計情報
  const avgConf = result.stats.avg_confidence;
  statsInfo.innerHTML = `
    <div>📊 総ボックス数: ${result.stats.total}</div>
    <div>📈 平均信頼度: ${avgConf}%</div>
    <div>⚡ 処理時間: ${result.stats.elapsed_ms}ms</div>
    <div style="margin-top: 10px; padding: 8px; background: rgba(${avgConf > 70 ? '0,255,0' : avgConf > 50 ? '255,165,0' : '255,0,0'},0.1); border-radius: 4px;">
      ${avgConf > 70 ? '✅ 精度良好' : avgConf > 50 ? '⚠️ 精度中程度 - 座標調整推奨' : '❌ 精度不良 - 座標再設定が必要'}
    </div>
  `;
  
  // デバッグ詳細
  debugDetails.innerHTML = result.results.map((r, i) => {
    const color = r.confidence > 50 ? '#0f0' : '#f90';
    return `<div style="padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.1);">
      [${i}] <strong>${r.label}</strong> → <span style="color: ${color}">${r.predicted}</span> (${r.confidence}%) 
      <span style="color: #666">| box: x=${r.box.x} y=${r.box.y} w=${r.box.w} h=${r.box.h}</span>
    </div>`;
  }).join('');
}

// リセットボタン
resetBtn.addEventListener('click', () => {
  scoreEl.textContent = '--';
  setStatus('準備完了。画像をペーストしてください。', false);
  document.getElementById('results-panel').style.display = 'none';
});

// Drag & Drop support
["dragenter","dragover"].forEach(evt => {
  dropZone.addEventListener(evt, (e) => {
    e.preventDefault();
    dropZone.classList.add("active");
  });
});

["dragleave","drop"].forEach(evt => {
  dropZone.addEventListener(evt, (e) => {
    e.preventDefault();
    dropZone.classList.remove("active");
  });
});

dropZone.addEventListener("drop", async (e) => {
  if (!warm) return;
  const file = [...e.dataTransfer.files].find(f => f.type.startsWith("image/"));
  await handleFile(file);
});
</script>
</body>
</html>